#!/usr/bin/env bash

OUTPUT_DIR="$HOME/Pictures/apod"
BKG_PATH="$HOME/Pictures/background.jpg"
DESCRIPTION_PATH="$HOME/.local/share/apod/description.txt"
KEY_PATH="$HOME/.config/apod/key"

nasa_api_key=$(cat "$KEY_PATH")
api_url="https://api.nasa.gov/planetary/apod?api_key=$nasa_api_key"

apod_json=$(curl -s $api_url)

if [ -z "$apod_json" ]; then
    echo "Could not get APOD. Exiting"
    exit 1
fi

media_type=$(echo $apod_json | jq -r .media_type)
description=$(echo $apod_json | jq -r .explanation)

if [ $media_type != "image" ]; then
    exit 2
fi

set_background () {
    ln -sf "$2" "$BKG_PATH"
    swaymsg "output * bg $BKG_PATH fill"
}
download_image () {
    wget --quiet -O "$2" "$1"
}

img_url=$(echo $apod_json | jq -r .hdurl)
img_date=$(echo $apod_json | jq -r .date)
img_title=$(echo $apod_json | jq -r .title)
output_path="$OUTPUT_DIR"/"$img_date"-"$img_title.jpg"

if [ ! -f "$output_path" ]; then
    download_image "$img_url" "$output_path"
else
    file_size=$(stat -c %s "$output_path")
    remote_size=$(wget --spider "$img_url" 2>&1 | grep Length | awk '{print $2}')
    if [ "$remote_size" -ne "$file_size" ]; then
        download_image "$img_url" "$output_path"
    fi
fi

set_background "$img_url" "$output_path"

echo "$description" > "$DESCRIPTION_PATH"
